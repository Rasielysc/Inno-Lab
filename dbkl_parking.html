<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>UBBL Parking Requirement Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #fff;
            text-align: justify;
            background-color: #111;
        }

        .topbar {
            background-color: #703D29;
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 50;
        }
        .logo {
            height: 40px;
        }

        .overlay {
            min-height: 100vh;
            padding-top: 4.5rem;
        }

        .section {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.6);
            margin-bottom: 4rem;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            color: #111;
        }

        .main-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #fff;
        }

        .section-header {
            font-weight: 700;
            font-size: 1.25rem;
            color: #111;
            text-align: center;
            margin-bottom: 1rem;
        }

        p.section-text {
            font-size: 0.9rem;
            line-height: 1.8;
            font-weight: 400;
            color: #111;
            margin-bottom: 1rem;
        }

        .button-grey {
            background-color: #f3f4f6;
            color: #111;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border: 2px solid #888;
            border-radius: 0.3rem;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            font-size: 0.875rem;
            text-align: center;
        }
        .button-grey:hover {
            background-color: #e5e7eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .btn-black {
            background-color: #000;
            color: #fff;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.3rem;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
        }
        .btn-black:hover {
            background-color: #222;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .result-box {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1.5rem;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .result-item:last-child {
            border-bottom: none;
        }

        .formula {
            font-size: 0.75rem;
            color: #4a4a4a;
            margin-left: 0.5rem;
        }
        
        .message-box {
            background-color: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .main-title { font-size: 2rem; }
            .section-header { font-size: 1rem; }
            .section { padding: 1.5rem; margin-left: 1rem; margin-right: 1rem; }
        }
    </style>
</head>
<body>

    <!-- Top Bar -->
    <div class="topbar">
        <img src="assets/logo.png" alt="Company Logo" class="logo rounded-full">
    </div>

    <!-- Main Content -->
    <div class="overlay">
        <div class="max-w-5xl mx-auto space-y-12 py-12">

            <!-- Main Title -->
            <h1 class="main-title">DBKL Parking Requirement Calculator</h1>

            <!-- Calculator Section -->
            <div class="section">
                <div class="section-header">Calculate Parking Requirements</div>

                <!-- Message Box for errors -->
                <div id="messageBox" class="message-box hidden"></div>

                <form id="parkingForm" class="space-y-4">
                    <div>
                        <label for="buildingType" class="block text-sm font-medium text-gray-700">Building Type</label>
                        <select id="buildingType" name="buildingType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="">Select a building type</option>
                            <option value="lowCostFlats">Low-cost flats / Public housing</option>
                            <option value="mediumCostFlatI">Medium Cost Flat I</option>
                            <option value="mediumCostFlatII">Medium Cost Flat II</option>
                            <option value="affordableHouse">Affordable House / PPA1M</option>
                            <option value="primaHousing">PRIMA Housing</option>
                            <option value="madaniHousing">MADANI Housing</option>
                            <option value="highCostFlatsI">High cost flats I</option>
                            <option value="highCostFlatsII">High cost flats II</option>
                            <option value="highCostFlatsIII">High cost flats III</option>
                            <option value="servicedApartment800">Serviced Apartment (800 sqft and above)</option>
                            <option value="servicedApartment450">Serviced Apartment (450-799 sqft)</option>
                            <option value="commercial">Perniagaan, Pusat Konvensyen, Pejabat, SOHO, Gedung Membeli belah</option>
                        </select>
                    </div>

                    <div id="unitsInputContainer" class="hidden">
                        <label for="numberOfUnits" class="block text-sm font-medium text-gray-700">Number of Units</label>
                        <input type="number" id="numberOfUnits" name="numberOfUnits" placeholder="e.g., 100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 text-black">
                    </div>

                    <div id="gfaInputContainer" class="hidden">
                        <label for="gfa" class="block text-sm font-medium text-gray-700">Gross Floor Area (GFA) in sqft</label>
                        <input type="number" id="gfa" name="gfa" placeholder="e.g., 50000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 text-black">
                    </div>

                    <div id="zoneInputContainer" class="hidden">
                        <label for="zone" class="block text-sm font-medium text-gray-700">Zone</label>
                        <select id="zone" name="zone" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="zone1">Zone 1</option>
                            <option value="zone2">Zone 2</option>
                            <option value="zone3">Zone 3</option>
                        </select>
                    </div>

                    <button type="button" onclick="calculateParking()" class="button-grey w-full mt-4">Calculate</button>
                </form>

                <div id="results" class="result-box hidden">
                    <div class="section-header">Required Parking Bays</div>
                    <div class="space-y-2">
                        <div class="result-item">
                            <span class="font-bold">Car Parking Bays (CPK):</span>
                            <span class="flex items-center">
                                <span id="cpkFormula" class="formula"></span>
                                <span id="cpkResult" class="text-right ml-2">0</span>
                            </span>
                        </div>
                        <div class="result-item" id="visitorRow">
                            <span class="font-bold">Visitor Parking Bays:</span>
                            <span class="flex items-center">
                                <span id="visitorCpkFormula" class="formula"></span>
                                <span id="visitorCpkResult" class="text-right ml-2">0</span>
                            </span>
                        </div>
                        <div class="result-item" id="totalCpkRow">
                            <span class="font-bold">Total Car Parking Bays:</span>
                            <span class="flex items-center">
                                <span id="totalCpkFormula" class="formula"></span>
                                <span id="totalCpkResult" class="text-right ml-2">0</span>
                            </span>
                        </div>
                        <div class="result-item">
                            <span class="font-bold">Motorcycle Parking Bays (MPK):</span>
                            <span class="flex items-center">
                                <span id="mpkFormula" class="formula"></span>
                                <span id="mpkResult" class="text-right ml-2">0</span>
                            </span>
                        </div>
                        <div class="result-item">
                            <span class="font-bold">Total Parking Bays (TLK):</span>
                            <span class="flex items-center">
                                <span id="tlkFormula" class="formula"></span>
                                <span id="tlkResult" class="text-right ml-2">0</span>
                            </span>
                        </div>
                        <div class="result-item">
                            <span class="font-bold">E-hailing TLM P-hailing:</span>
                            <span class="flex items-center">
                                <span id="ehailingMpkFormula" class="formula"></span>
                                <span id="ehailingMpkResult" class="text-right ml-2">0</span>
                            </span>
                        </div>
                        <div class="result-item">
                            <span class="font-bold">E-hailing TLK P-hailing:</span>
                            <span class="flex items-center">
                                <span id="ehailingCpkFormula" class="formula"></span>
                                <span id="ehailingCpkResult" class="text-right ml-2">0</span>
                            </span>
                        </div>
                        <div class="result-item">
                            <span class="font-bold">EV Charging Bays (EVCB):</span>
                            <span class="flex items-center">
                                <span id="evcbFormula" class="formula"></span>
                                <span id="evcbResult" class="text-right ml-2">0</span>
                            </span>
                        </div>
                        <div class="result-item">
                            <span class="font-bold">Disabled Bays (OKU):</span>
                            <span class="flex items-center">
                                <span id="okuFormula" class="formula"></span>
                                <span id="okuResult" class="text-right ml-2">0</span>
                            </span>
                        </div>
                    </div>
                    <button type="button" onclick="exportToExcel()" class="btn-black w-full mt-4">Export to Excel</button>
                </div>

                <!-- Back to Main Menu Button -->
                <div class="flex justify-center mt-8">
                    <a href="index.html" class="button-grey w-full md:w-1/3 flex items-center justify-center">
                        Back to Main Menu
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const parkingRules = {
            'lowCostFlats': { cpkPerUnit: 1, mpkCalc: (units) => Math.round(units * 0.5), ehailing: false, cpkVisitorPercent: 0, mpkFormula: 'Units x 50%' },
            'mediumCostFlatI': { cpkPerUnit: 1, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.round(units * 0.3), ehailing: false, mpkFormula: 'Units x 30%' },
            'mediumCostFlatII': { cpkPerUnit: 1, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.round(units * 0.3), ehailing: false, mpkFormula: 'Units x 30%' },
            'affordableHouse': { cpkPerUnit: 1, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.round(units * 0.3), ehailing: false, mpkFormula: 'Units x 30%' },
            'primaHousing': { cpkPerUnit: 1, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.round(units * 0.1), ehailing: false, mpkFormula: 'Units x 10%' },
            'madaniHousing': { cpkPerUnit: 1, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.round(units * 0.5), ehailing: false, mpkFormula: 'Units x 50%' },
            'highCostFlatsI': { cpkPerUnit: 2, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.round(units * 0.1), ehailing: false, mpkFormula: 'Units x 10%' },
            'highCostFlatsII': { cpkPerUnit: 2.2, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.round(units * 0.05), ehailing: false, mpkFormula: 'Units x 5%' },
            'highCostFlatsIII': { cpkPerUnit: 2.5, cpkVisitorPercent: 0.1, mpkCalc: (units) => Math.round(units * 0.05), ehailing: false, mpkFormula: 'Units x 5%' },
            'servicedApartment800': { gfaBased: true, cpkCalc: { zone1: 1000, zone2: 800, zone3: 500 }, cpkGfaDeduct: 0.35, cpkVisitorPercent: 0.1, mpkCalc: (gfa) => Math.round(gfa / 2000), ehailing: false, mpkFormula: 'GFA / 2000 sqft' },
            'servicedApartment450': { gfaBased: true, cpkCalc: { zone1: 1000, zone2: 800, zone3: 500 }, cpkGfaDeduct: 0.35, cpkVisitorPercent: 0, mpkCalc: (gfa) => Math.round(gfa / 2000), ehailing: false, mpkFormula: 'GFA / 2000 sqft' },
            'commercial': { gfaBased: true, mpkCalc: (gfa) => Math.round(gfa / 2000), ehailing: true, cpkVisitorPercent: 0, mpkFormula: 'GFA / 2000 sqft' },
        };

        const buildingTypeSelect = document.getElementById('buildingType');
        const unitsInputContainer = document.getElementById('unitsInputContainer');
        const gfaInputContainer = document.getElementById('gfaInputContainer');
        const zoneInputContainer = document.getElementById('zoneInputContainer');
        const resultsDiv = document.getElementById('results');
        const messageBox = document.getElementById('messageBox');

        buildingTypeSelect.addEventListener('change', () => {
            const type = buildingTypeSelect.value;
            const rules = parkingRules[type];

            unitsInputContainer.classList.add('hidden');
            gfaInputContainer.classList.add('hidden');
            zoneInputContainer.classList.add('hidden');
            resultsDiv.classList.add('hidden');
            hideMessage();

            if (rules) {
                if (rules.gfaBased) {
                    gfaInputContainer.classList.remove('hidden');
                    zoneInputContainer.classList.remove('hidden');
                } else {
                    unitsInputContainer.classList.remove('hidden');
                }
            }
        });

        function showMessage(message) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            messageBox.textContent = '';
            messageBox.classList.add('hidden');
        }

        function calculateParking() {
            hideMessage();
            const buildingType = buildingTypeSelect.value;
            const rules = parkingRules[buildingType];

            if (!rules) {
                showMessage("Please select a building type.");
                return;
            }

            let cpk, visitorCpk, mpk, ehailingCpk, ehailingMpk, evcb, oku;
            let baseValue;
            let cpkFormulaText, visitorCpkFormulaText, totalCpkFormulaText, mpkFormulaText, ehailingCpkFormulaText, ehailingMpkFormulaText, evcbFormulaText, okuFormulaText;

            if (rules.gfaBased) {
                const gfa = parseFloat(document.getElementById('gfa').value);
                const zone = document.getElementById('zone').value;

                if (isNaN(gfa) || gfa <= 0) {
                    showMessage("Please enter a valid Gross Floor Area (GFA) greater than 0.");
                    return;
                }
                baseValue = gfa;

                let cpkDeduction;
                let cpkDivisor;
                
                if (buildingType === 'commercial') {
                    cpkDeduction = 0.30;
                    switch(zone) {
                        case 'zone1':
                            cpkDivisor = 1000;
                            break;
                        case 'zone2':
                            cpkDivisor = 800;
                            break;
                        case 'zone3':
                            cpkDivisor = 500;
                            break;
                        default:
                            showMessage("Invalid zone selected.");
                            return;
                    }
                } else { // Serviced Apartments
                    cpkDeduction = rules.cpkGfaDeduct;
                    cpkDivisor = rules.cpkCalc[zone];
                }
                
                const cpkBase = gfa * (1 - cpkDeduction);
                cpk = Math.round(cpkBase / cpkDivisor);
                cpkFormulaText = `(GFA - ${cpkDeduction * 100}%) / ${cpkDivisor} sqft`;

                mpk = rules.mpkCalc(baseValue);
                mpkFormulaText = rules.mpkFormula;

                if (rules.ehailing) {
                    if (gfa >= 100000 && gfa <= 199999) {
                        ehailingMpk = 10;
                        ehailingCpk = 2;
                        ehailingCpkFormulaText = 'Tiered rule based on GFA';
                        ehailingMpkFormulaText = 'Tiered rule based on GFA';
                    } else if (gfa >= 200000 && gfa <= 299999) {
                        ehailingMpk = 12;
                        ehailingCpk = 3;
                        ehailingCpkFormulaText = 'Tiered rule based on GFA';
                        ehailingMpkFormulaText = 'Tiered rule based on GFA';
                    } else if (gfa >= 300000 && gfa <= 399999) {
                        ehailingMpk = 14;
                        ehailingCpk = 4;
                        ehailingCpkFormulaText = 'Tiered rule based on GFA';
                        ehailingMpkFormulaText = 'Tiered rule based on GFA';
                    } else if (gfa >= 400000 && gfa <= 499999) {
                        ehailingMpk = 16;
                        ehailingCpk = 5;
                        ehailingCpkFormulaText = 'Tiered rule based on GFA';
                        ehailingMpkFormulaText = 'Tiered rule based on GFA';
                    } else if (gfa >= 500000) {
                        ehailingMpk = 20;
                        ehailingCpk = 5;
                        ehailingCpkFormulaText = 'Tiered rule based on GFA';
                        ehailingMpkFormulaText = 'Tiered rule based on GFA';
                    } else {
                        ehailingMpk = 0;
                        ehailingCpk = 0;
                        ehailingCpkFormulaText = 'N/A (<100,000 sqft)';
                        ehailingMpkFormulaText = 'N/A (<100,000 sqft)';
                    }
                } else {
                    ehailingCpk = rules.ehailing ? 2 : 0;
                    ehailingMpk = rules.ehailing ? 2 : 0;
                    ehailingCpkFormulaText = rules.ehailing ? 'Fixed 2 bays' : 'N/A';
                    ehailingMpkFormulaText = rules.ehailing ? 'Fixed 2 bays' : 'N/A';
                }

                visitorCpk = 0; // Commercial buildings have no visitor parking based on new rule
                visitorCpkFormulaText = 'N/A';
            } else {
                const units = parseInt(document.getElementById('numberOfUnits').value);
                if (isNaN(units) || units <= 0) {
                    showMessage("Please enter a valid number of units greater than 0.");
                    return;
                }
                baseValue = units;
                cpk = Math.round(units * rules.cpkPerUnit);
                cpkFormulaText = `${units} units x ${rules.cpkPerUnit}`;

                visitorCpk = Math.round(cpk * rules.cpkVisitorPercent);
                visitorCpkFormulaText = `${cpk} bays x ${rules.cpkVisitorPercent * 100}%`;

                mpk = rules.mpkCalc(baseValue);
                mpkFormulaText = rules.mpkFormula;

                ehailingCpk = rules.ehailing ? 2 : 0;
                ehailingMpk = rules.ehailing ? 2 : 0;
                ehailingCpkFormulaText = rules.ehailing ? 'Fixed 2 bays' : 'N/A';
                ehailingMpkFormulaText = rules.ehailing ? 'Fixed 2 bays' : 'N/A';
            }

            const totalCpk = cpk + visitorCpk;
            totalCpkFormulaText = `${cpk} + ${visitorCpk}`;

            const tlk = totalCpk;
            tlkFormulaText = `Total Car Parking Bays`;

            // EVCB Calculation based on new rules
            if (tlk <= 50) {
                evcb = 1;
                evcbFormulaText = 'Tiered rule (1 bay)';
            } else if (tlk <= 100) {
                evcb = 2;
                evcbFormulaText = 'Tiered rule (2 bays)';
            } else {
                const additionalBays = Math.round((tlk - 100) / 100);
                evcb = 2 + additionalBays;
                evcbFormulaText = `2 + round((${tlk} - 100) / 100)`;
            }

            // OKU Calculation based on new rules
            if (totalCpk <= 25) {
                oku = 1;
                okuFormulaText = 'Tiered rule (1 bay)';
            } else if (totalCpk <= 50) {
                oku = 2;
                okuFormulaText = 'Tiered rule (2 bays)';
            } else if (totalCpk <= 100) {
                oku = 4;
                okuFormulaText = 'Tiered rule (4 bays)';
            } else if (totalCpk <= 200) {
                oku = 6;
                okuFormulaText = 'Tiered rule (6 bays)';
            } else {
                const additionalBays = Math.round((totalCpk - 200) / 100);
                oku = 6 + additionalBays;
                okuFormulaText = `6 + round((${totalCpk} - 200) / 100)`;
            }

            document.getElementById('cpkResult').textContent = cpk;
            document.getElementById('cpkFormula').textContent = cpkFormulaText;

            document.getElementById('visitorCpkResult').textContent = visitorCpk;
            document.getElementById('visitorCpkFormula').textContent = visitorCpkFormulaText;

            document.getElementById('totalCpkResult').textContent = totalCpk;
            document.getElementById('totalCpkFormula').textContent = totalCpkFormulaText;

            document.getElementById('mpkResult').textContent = mpk;
            document.getElementById('mpkFormula').textContent = mpkFormulaText;

            document.getElementById('tlkResult').textContent = tlk;
            document.getElementById('tlkFormula').textContent = tlkFormulaText;

            document.getElementById('ehailingCpkResult').textContent = ehailingCpk;
            document.getElementById('ehailingCpkFormula').textContent = ehailingCpkFormulaText;

            document.getElementById('ehailingMpkResult').textContent = ehailingMpk;
            document.getElementById('ehailingMpkFormula').textContent = ehailingMpkFormulaText;

            document.getElementById('evcbResult').textContent = evcb;
            document.getElementById('evcbFormula').textContent = evcbFormulaText;

            document.getElementById('okuResult').textContent = oku;
            document.getElementById('okuFormula').textContent = okuFormulaText;

            if (rules.cpkVisitorPercent === 0) {
                document.getElementById('visitorRow').classList.add('hidden');
            } else {
                document.getElementById('visitorRow').classList.remove('hidden');
            }

            resultsDiv.classList.remove('hidden');
        }

        function exportToExcel() {
            const buildingType = document.getElementById('buildingType').value;
            const results = {
                'Car Parking Bays (CPK)': document.getElementById('cpkResult').textContent,
                'Visitor Parking Bays': document.getElementById('visitorCpkResult').textContent,
                'Total Car Parking Bays': document.getElementById('totalCpkResult').textContent,
                'Motorcycle Parking Bays (MPK)': document.getElementById('mpkResult').textContent,
                'Total Parking Bays (TLK)': document.getElementById('tlkResult').textContent,
                'E-hailing TLM P-hailing': document.getElementById('ehailingMpkResult').textContent,
                'E-hailing TLK P-hailing': document.getElementById('ehailingCpkResult').textContent,
                'EV Charging Bays (EVCB)': document.getElementById('evcbResult').textContent,
                'Disabled Bays (OKU)': document.getElementById('okuResult').textContent
            };

            let excelData = `Parking Requirement for ${buildingType}\n\n`;
            for (const key in results) {
                excelData += `${key},${results[key]}\n`;
            }

            const blob = new Blob([excelData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `parking_requirements_${buildingType}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>
